<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Battler Combat Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap');
        body { font-family: 'Prompt', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        /* Checkbox styling */
        input[type=checkbox] { accent-color: #6366f1; width: 1rem; height: 1rem; cursor: pointer; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center">

    <div class="w-full max-w-7xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">‚öîÔ∏è Auto-Battler System Studio</h1>
            <p class="text-slate-400 text-sm">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏Å‡∏¥‡∏•‡πÅ‡∏ö‡∏ö Dynamic Rule-based (‡∏™‡πÑ‡∏ï‡∏•‡πå Dulst) ‡πÅ‡∏•‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
        </div>

        <!-- ========================================== -->
        <!-- SECTION 1: SKILL BUILDER                   -->
        <!-- ========================================== -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            
            <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏Å‡∏¥‡∏•‡πÅ‡∏ö‡∏ö Dynamic -->
            <div class="bg-slate-800 rounded-xl p-5 border border-slate-700 shadow-lg flex flex-col max-h-[800px]">
                <div class="flex justify-between items-center border-b border-slate-700 pb-3 mb-4 shrink-0">
                    <h2 class="text-xl font-semibold text-purple-400" id="builder_title">üõ†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏Å‡∏¥‡∏• (Dynamic Builder)</h2>
                    <span id="editing_badge" class="hidden bg-yellow-600/30 border border-yellow-500 text-yellow-300 text-xs px-2 py-1 rounded animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏Å‡∏¥‡∏•</span>
                </div>
                
                <div class="space-y-4 overflow-y-auto custom-scrollbar pr-2 flex-1 pb-4" id="skill_form">
                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
                    <div class="grid grid-cols-2 gap-4 bg-slate-900 p-4 rounded-lg border border-slate-700">
                        <div class="col-span-2 text-sm font-semibold text-slate-300 border-b border-slate-700 pb-1">üìÑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</div>
                        <div class="col-span-2">
                            <label class="block text-xs text-slate-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏¥‡∏• (Name)</label>
                            <input type="text" id="c_name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡∏≤‡∏ö‡∏î‡∏π‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î, ‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏û‡∏•‡∏µ‡∏ä‡∏µ‡∏û" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" oninput="updateLivePreview()">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs text-slate-400 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (Description)</label>
                            <textarea id="c_desc" rows="2" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" oninput="updateLivePreview()"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡πà‡∏≤‡∏¢ (Cast Time)</label>
                            <input type="number" id="c_castTime" value="0" step="0.5" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" oninput="updateLivePreview()">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå (Cooldown)</label>
                            <input type="number" id="c_cooldown" value="3.0" step="0.5" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm" oninput="updateLivePreview()">
                        </div>
                        <div class="col-span-2 flex items-center gap-2 mt-1">
                            <input type="checkbox" id="c_uninterruptible" onchange="updateLivePreview()" class="w-4 h-4 accent-indigo-500 cursor-pointer">
                            <label class="text-sm text-indigo-300 cursor-pointer" for="c_uninterruptible">üõ°Ô∏è ‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏Ç‡∏±‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏Ç‡∏ì‡∏∞‡∏£‡πà‡∏≤‡∏¢ (Super Armor)</label>
                        </div>
                    </div>

                    <!-- ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà Effect ‡πÅ‡∏ö‡∏ö Dynamic -->
                    <div class="bg-slate-900 p-4 rounded-lg border border-slate-700">
                        <div class="flex justify-between items-center border-b border-slate-700 pb-2 mb-3">
                            <h3 class="text-sm font-semibold text-slate-300">‚öôÔ∏è ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏™‡∏Å‡∏¥‡∏• (Effects Execution)</h3>
                        </div>
                        
                        <!-- ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏™‡πà Effect Blocks -->
                        <div id="dynamic_effects_container" class="space-y-3 mb-4">
                            <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
                        </div>

                        <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏° Effect -->
                        <div class="flex gap-2 p-3 bg-slate-800/50 rounded border border-slate-700 border-dashed">
                            <select id="new_effect_type" class="flex-1 bg-slate-900 border border-slate-600 rounded p-2 text-sm text-white focus:outline-none focus:border-purple-500">
                                <option value="CONDITION">‚ùì ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (Condition Gate)</option>
                                <option value="DAMAGE">‚öîÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ (Damage)</option>
                                <option value="HEAL">üíö ‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï (Heal)</option>
                                <option value="INTERRUPT">üõë ‡∏Ç‡∏±‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏¢ (Interrupt)</option>
                                <option value="STUN">üí´ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏°‡∏∂‡∏ô‡∏á‡∏á (Stun)</option>
                                <option value="BUFF_NEXT_SKILL">üî• ‡∏ö‡∏±‡∏ü‡∏™‡∏Å‡∏¥‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Empower)</option>
                            </select>
                            <button onclick="addEffectBlock()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold px-4 rounded transition text-sm shadow">
                                + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
                            </button>
                        </div>
                    </div>

                    <div id="creator_error" class="hidden text-red-400 text-sm font-semibold text-center">
                        ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° Effect ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
                    </div>
                </div>

                <div class="flex gap-2 pt-4 border-t border-slate-700 shrink-0">
                    <button id="cancel_edit_btn" onclick="resetForm()" class="hidden w-1/3 bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-[0.98]">
                        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button id="save_btn" onclick="saveSkill()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-[0.98]">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Å‡∏¥‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>

            <!-- ‡∏Ç‡∏ß‡∏≤: Firestore Preview -->
            <div class="bg-black rounded-xl border border-slate-700 shadow-lg flex flex-col overflow-hidden max-h-[800px]">
                <div class="bg-slate-800 p-3 border-b border-slate-700 flex justify-between items-center shrink-0">
                    <h3 class="font-semibold text-orange-400">üóÑÔ∏è ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á JSON ‡∏Ç‡∏≠‡∏á‡∏™‡∏Å‡∏¥‡∏• (Live)</h3>
                    <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">Database Schema</span>
                </div>
                <div class="p-4 flex-1 bg-[#0d1117] overflow-y-auto custom-scrollbar">
                    <pre id="live_json_preview" class="text-xs text-green-400 font-mono whitespace-pre-wrap leading-relaxed"></pre>
                </div>
            </div>

        </div>

        <!-- ========================================== -->
        <!-- SECTION 2: SKILL LIBRARY                   -->
        <!-- ========================================== -->
        <div class="bg-slate-800 rounded-xl p-5 border border-slate-700 shadow-lg mb-8">
            <h2 class="text-xl font-semibold text-blue-400 mb-4 border-b border-slate-700 pb-2">üìö ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏Å‡∏¥‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Skill Database)</h2>
            <div id="skill_library_container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <div class="col-span-full text-center text-slate-500 py-6">
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏Å‡∏¥‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏Å‡∏¥‡∏•‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- SECTION 3: SETUP STATS & EQUIP             -->
        <!-- ========================================== -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            
            <!-- ‡∏ù‡∏±‡πà‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô -->
            <div class="bg-slate-800 rounded-xl p-5 border border-slate-700 shadow-lg">
                <div class="flex justify-between items-center border-b border-slate-700 pb-2 mb-4">
                    <h2 class="text-xl font-semibold text-blue-400">1Ô∏è‚É£ ‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (Player)</h2>
                    <div class="flex items-center gap-2">
                        <label class="text-xs text-slate-400">Max HP</label>
                        <input type="number" id="p1_hp" value="1500" class="w-20 bg-slate-900 border border-slate-700 rounded p-1 text-white text-right">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 mb-4">
                    <div class="col-span-2 text-sm font-semibold text-orange-300 mt-2 border-b border-slate-700/50 pb-1">‚öîÔ∏è ‡∏´‡∏°‡∏ß‡∏î‡∏û‡∏•‡∏±‡∏á‡πÇ‡∏à‡∏°‡∏ï‡∏µ</div>
                    <div><label class="block text-[10px] text-slate-400">‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Base ATK)</label><input type="number" id="p1_baseAtk" value="20" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                    <div><label class="block text-[10px] text-slate-400">‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û (Phys ATK)</label><input type="number" id="p1_physAtk" value="40" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                    <div><label class="block text-[10px] text-slate-400">‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå (Mag ATK)</label><input type="number" id="p1_magAtk" value="10" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                    <div><label class="block text-[10px] text-slate-400">‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏Ñ‡∏£‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏≠‡∏• (Crit ATK)</label><input type="number" id="p1_critAtk" value="50" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>

                    <div class="col-span-2 text-sm font-semibold text-emerald-300 mt-2 border-b border-slate-700/50 pb-1">üõ°Ô∏è ‡∏´‡∏°‡∏ß‡∏î‡∏û‡∏•‡∏±‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô</div>
                    <div class="col-span-2 grid grid-cols-3 gap-2">
                        <div><label class="block text-[10px] text-slate-400">‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</label><input type="number" id="p1_baseDef" value="10" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                        <div><label class="block text-[10px] text-slate-400">‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û</label><input type="number" id="p1_physDef" value="15" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                        <div><label class="block text-[10px] text-slate-400">‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå</label><input type="number" id="p1_magDef" value="5" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                    </div>

                    <div class="col-span-2 text-sm font-semibold text-purple-300 mt-2 border-b border-slate-700/50 pb-1">‚ú® ‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°</div>
                    <div class="col-span-2 grid grid-cols-3 gap-2">
                        <div><label class="block text-[10px] text-slate-400">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (Accuracy)</label><input type="number" id="p1_accuracy" value="100" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                        <div><label class="block text-[10px] text-slate-400">‡∏´‡∏•‡∏ö‡∏´‡∏•‡∏µ‡∏Å (Evasion)</label><input type="number" id="p1_evasion" value="10" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                        <div><label class="block text-[10px] text-slate-400">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏≠‡∏• (CRI)</label><input type="number" id="p1_critChance" value="100" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                    </div>
                </div>

                <div class="space-y-2 mt-4 bg-slate-900 p-3 rounded border border-slate-700" id="p1_skills_container">
                    <label class="block text-xs font-semibold text-blue-300 mb-2 border-b border-slate-700 pb-1">üì• ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏Å‡∏¥‡∏• (‡∏ã‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤)</label>
                    <div id="p1_select_wrapper" class="space-y-1"></div>
                </div>
            </div>

            <!-- ‡∏ù‡∏±‡πà‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π -->
            <div class="bg-slate-800 rounded-xl p-5 border border-slate-700 shadow-lg">
                <div class="flex justify-between items-center border-b border-slate-700 pb-2 mb-4">
                    <h2 class="text-xl font-semibold text-red-400">2Ô∏è‚É£ ‡∏ù‡πà‡∏≤‡∏¢‡∏®‡∏±‡∏ï‡∏£‡∏π (Enemy)</h2>
                    <div class="flex items-center gap-2">
                        <label class="text-xs text-slate-400">Max HP</label>
                        <input type="number" id="p2_hp" value="2000" class="w-20 bg-slate-900 border border-slate-700 rounded p-1 text-white text-right">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 mb-4">
                    <div class="col-span-2 text-sm font-semibold text-orange-300 mt-2 border-b border-slate-700/50 pb-1">‚öîÔ∏è ‡∏´‡∏°‡∏ß‡∏î‡∏û‡∏•‡∏±‡∏á‡πÇ‡∏à‡∏°‡∏ï‡∏µ</div>
                    <div><label class="block text-[10px] text-slate-400">‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Base ATK)</label><input type="number" id="p2_baseAtk" value="25" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                    <div><label class="block text-[10px] text-slate-400">‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û (Phys ATK)</label><input type="number" id="p2_physAtk" value="30" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                    <div><label class="block text-[10px] text-slate-400">‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå (Mag ATK)</label><input type="number" id="p2_magAtk" value="5" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                    <div><label class="block text-[10px] text-slate-400">‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏Ñ‡∏£‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏≠‡∏• (Crit ATK)</label><input type="number" id="p2_critAtk" value="40" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>

                    <div class="col-span-2 text-sm font-semibold text-emerald-300 mt-2 border-b border-slate-700/50 pb-1">üõ°Ô∏è ‡∏´‡∏°‡∏ß‡∏î‡∏û‡∏•‡∏±‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô</div>
                    <div class="col-span-2 grid grid-cols-3 gap-2">
                        <div><label class="block text-[10px] text-slate-400">‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</label><input type="number" id="p2_baseDef" value="15" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                        <div><label class="block text-[10px] text-slate-400">‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û</label><input type="number" id="p2_physDef" value="20" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                        <div><label class="block text-[10px] text-slate-400">‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå</label><input type="number" id="p2_magDef" value="5" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                    </div>

                    <div class="col-span-2 text-sm font-semibold text-purple-300 mt-2 border-b border-slate-700/50 pb-1">‚ú® ‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°</div>
                    <div class="col-span-2 grid grid-cols-3 gap-2">
                        <div><label class="block text-[10px] text-slate-400">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (Accuracy)</label><input type="number" id="p2_accuracy" value="90" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                        <div><label class="block text-[10px] text-slate-400">‡∏´‡∏•‡∏ö‡∏´‡∏•‡∏µ‡∏Å (Evasion)</label><input type="number" id="p2_evasion" value="5" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                        <div><label class="block text-[10px] text-slate-400">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏≠‡∏• (CRI)</label><input type="number" id="p2_critChance" value="50" class="w-full bg-slate-900 border border-slate-700 rounded p-1.5 text-white"></div>
                    </div>
                </div>

                <div class="space-y-2 mt-4 bg-slate-900 p-3 rounded border border-slate-700" id="p2_skills_container">
                    <label class="block text-xs font-semibold text-red-300 mb-2 border-b border-slate-700 pb-1">üì• ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏Å‡∏¥‡∏• (‡∏ã‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤)</label>
                    <div id="p2_select_wrapper" class="space-y-1"></div>
                </div>
            </div>

        </div>

        <div class="flex flex-col items-center mb-8">
            <button onclick="runSimulation()" class="bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-bold py-4 px-12 rounded-full shadow-[0_0_20px_rgba(16,185,129,0.4)] transform transition hover:scale-105 active:scale-95 text-xl tracking-wide">
                ‚öîÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ (Calculate)
            </button>
            <div id="sim_error" class="hidden text-red-400 text-sm font-semibold mt-3">
                ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏Å‡∏¥‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡∏Å‡∏¥‡∏• ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
            </div>
        </div>

        <!-- ========================================== -->
        <!-- SECTION 4: SIMULATION LOGS                 -->
        <!-- ========================================== -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-[600px]">
            
            <!-- In-Game Log -->
            <div class="bg-slate-900 rounded-xl border border-slate-700 shadow-lg flex flex-col h-full overflow-hidden">
                <div class="bg-slate-800 p-3 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="font-semibold text-emerald-400">üìú In-Game Combat Log</h3>
                    <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</span>
                </div>
                <div id="ui_log" class="p-4 overflow-y-auto custom-scrollbar flex-1 space-y-2 text-sm">
                    <div class="text-slate-500 text-center mt-10">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏Å‡∏¥‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
                </div>
            </div>

            <!-- Battle Record JSON -->
            <div class="bg-black rounded-xl border border-slate-700 shadow-lg flex flex-col h-full overflow-hidden">
                <div class="bg-slate-800 p-3 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="font-semibold text-orange-400">üóÑÔ∏è Battle Record (Firestore JSON)</h3>
                    <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (Backend)</span>
                </div>
                <pre id="fs_log" class="p-4 overflow-y-auto custom-scrollbar flex-1 text-xs text-green-400 font-mono whitespace-pre-wrap">
// ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Database
                </pre>
            </div>

        </div>

    </div>

    <!-- Global Tooltip Container -->
    <div id="global_tooltip" class="fixed pointer-events-none opacity-0 z-[9999] transition-opacity duration-150 w-64 bg-gradient-to-b from-slate-800 to-slate-900 border border-slate-500 rounded-md shadow-[0_4px_25px_rgba(0,0,0,0.9)] p-3 text-left flex flex-col gap-1">
        <div id="tt_name" class="font-bold text-yellow-400 text-sm border-b border-slate-600 pb-1"></div>
        <div id="tt_badges" class="flex flex-wrap mt-1"></div>
        <div class="text-[11px] text-slate-300 grid grid-cols-2 gap-1 my-1">
            <div>‚è±Ô∏è ‡∏£‡πà‡∏≤‡∏¢: <span id="tt_cast" class="text-white font-semibold"></span>s</div>
            <div>‚è≥ ‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå: <span id="tt_cd" class="text-white font-semibold"></span>s</div>
        </div>
        <div id="tt_desc" class="text-[12px] text-slate-300 leading-relaxed border-t border-slate-600 pt-2 mt-1"></div>
    </div>

    <script>
        // -----------------------------------------------------------
        // 1. DYNAMIC SKILL BUILDER SYSTEM
        // -----------------------------------------------------------
        let skillDB = {};
        let skillCounter = 1;
        let effectBlockCounter = 0;
        let editingSkillId = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏Å‡∏¥‡∏•‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà

        function removeEffectBlock(id) {
            document.getElementById(id).remove();
            updateLivePreview();
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° (effData)
        function addEffectBlock(preloadedType = null, effData = null) {
            const type = preloadedType || document.getElementById('new_effect_type').value;
            const blockId = `eff_block_${effectBlockCounter++}`;
            
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏î‡∏¥‡∏° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Type
            const target = effData ? effData.target : (['DAMAGE', 'INTERRUPT', 'STUN', 'CONDITION'].includes(type) ? 'ENEMY' : 'SELF');
            
            let typeLabel = "";
            let colorBorder = "";
            let fieldsHtml = "";

            let targetSelectHtml = `
                <div class="mb-2">
                    <label class="text-[10px] text-slate-400 mr-2">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Target):</label>
                    <select class="eff-target bg-slate-900 border border-slate-600 rounded p-1 text-xs text-white" onchange="updateLivePreview()">
                        <option value="ENEMY" ${target === 'ENEMY' ? 'selected' : ''}>‡∏®‡∏±‡∏ï‡∏£‡∏π (Enemy)</option>
                        <option value="SELF" ${target === 'SELF' ? 'selected' : ''}>‡∏ï‡∏ô‡πÄ‡∏≠‡∏á (Self)</option>
                    </select>
                </div>
            `;

            if (type === "CONDITION") {
                typeLabel = "‚ùì ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏±‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô)"; colorBorder = "border-yellow-500";
                const cStat = effData ? effData.stat : "HP_PERCENT";
                const cOp = effData ? effData.operator : "<=";
                const cVal = effData ? effData.value : 50;
                fieldsHtml = `
                    <div class="grid grid-cols-3 gap-2 mt-2">
                        <div>
                            <label class="block text-[10px] text-slate-400">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤</label>
                            <select class="eff-condStat w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-xs text-white" onchange="updateLivePreview()">
                                <option value="HP_PERCENT" ${cStat === 'HP_PERCENT' ? 'selected' : ''}>HP (%)</option>
                                <option value="HP_CURRENT" ${cStat === 'HP_CURRENT' ? 'selected' : ''}>HP (‡∏´‡∏ô‡πà‡∏ß‡∏¢)</option>
                                <option value="BASE_ATK" ${cStat === 'BASE_ATK' ? 'selected' : ''}>‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</option>
                                <option value="PHYS_DEF" ${cStat === 'PHYS_DEF' ? 'selected' : ''}>‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û</option>
                                <option value="MAG_DEF" ${cStat === 'MAG_DEF' ? 'selected' : ''}>‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå</option>
                                <option value="ACCURACY" ${cStat === 'ACCURACY' ? 'selected' : ''}>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</option>
                                <option value="EVASION" ${cStat === 'EVASION' ? 'selected' : ''}>‡∏´‡∏•‡∏ö‡∏´‡∏•‡∏µ‡∏Å</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400">‡∏ï‡∏±‡∏ß‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</label>
                            <select class="eff-condOp w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-xs text-white" onchange="updateLivePreview()">
                                <option value="<" ${cOp === '<' ? 'selected' : ''}>< (‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤)</option>
                                <option value="<=" ${cOp === '<=' ? 'selected' : ''}><= (‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö)</option>
                                <option value="==" ${cOp === '==' ? 'selected' : ''}>== (‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö)</option>
                                <option value=">=" ${cOp === '>=' ? 'selected' : ''}>>= (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö)</option>
                                <option value=">" ${cOp === '>' ? 'selected' : ''}>> (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400">‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</label>
                            <input type="number" class="eff-condVal w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-xs text-white" value="${cVal}" oninput="updateLivePreview()">
                        </div>
                    </div>
                `;
            } else if (type === "DAMAGE") {
                typeLabel = "‚öîÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢"; colorBorder = "border-orange-600";
                const dType = effData ? effData.dmgType : "PHYSICAL";
                const dMult = effData ? effData.mult : 1.0;
                const dMin = effData ? effData.baseMin : 10;
                const dMax = effData ? effData.baseMax : 20;
                fieldsHtml = `
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div class="col-span-2">
                            <label class="block text-[10px] text-slate-400">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</label>
                            <select class="eff-dmgType w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-xs text-white" onchange="updateLivePreview()">
                                <option value="PHYSICAL" ${dType === 'PHYSICAL' ? 'selected' : ''}>‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û (Physical)</option>
                                <option value="MAGICAL" ${dType === 'MAGICAL' ? 'selected' : ''}>‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå (Magical)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400">‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏à‡∏≤‡∏Å ATK</label>
                            <input type="number" class="eff-dmgMult w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-xs text-white" value="${dMult}" step="0.1" oninput="updateLivePreview()">
                        </div>
                        <div class="grid grid-cols-2 gap-1">
                            <div>
                                <label class="block text-[10px] text-slate-400">Base ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</label>
                                <input type="number" class="eff-dmgMin w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-xs text-white" value="${dMin}" oninput="updateLivePreview()">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-400">Base ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</label>
                                <input type="number" class="eff-dmgMax w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-xs text-white" value="${dMax}" oninput="updateLivePreview()">
                            </div>
                        </div>
                    </div>
                `;
            } else if (type === "HEAL") {
                typeLabel = "üíö ‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï"; colorBorder = "border-emerald-600";
                const hBase = effData ? effData.base : 100;
                fieldsHtml = `
                    <div class="mt-2">
                        <label class="block text-[10px] text-slate-400">‡∏Ñ‡πà‡∏≤‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</label>
                        <input type="number" class="eff-healBase w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-xs text-white" value="${hBase}" oninput="updateLivePreview()">
                    </div>
                `;
            } else if (type === "INTERRUPT") {
                typeLabel = "üõë ‡∏Ç‡∏±‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏¢"; colorBorder = "border-red-600";
                fieldsHtml = `<div class="text-xs text-slate-400 mt-2 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div>`;
            } else if (type === "STUN") {
                typeLabel = "üí´ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏°‡∏∂‡∏ô‡∏á‡∏á"; colorBorder = "border-purple-600";
                const sChance = effData ? effData.chance : 1.0;
                const sDur = effData ? effData.duration : 2.0;
                fieldsHtml = `
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <label class="block text-[10px] text-slate-400">‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ï‡∏¥‡∏î (0.0 - 1.0)</label>
                            <input type="number" class="eff-stunChance w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-xs text-white" value="${sChance}" step="0.1" oninput="updateLivePreview()">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                            <input type="number" class="eff-stunDur w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-xs text-white" value="${sDur}" step="0.5" oninput="updateLivePreview()">
                        </div>
                    </div>
                `;
            } else if (type === "BUFF_NEXT_SKILL") {
                typeLabel = "üî• ‡∏ö‡∏±‡∏ü‡∏™‡∏Å‡∏¥‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"; colorBorder = "border-pink-600";
                const bMult = effData ? effData.mult : 2.0;
                fieldsHtml = `
                    <div class="mt-2">
                        <label class="block text-[10px] text-slate-400">‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏™‡∏Å‡∏¥‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
                        <input type="number" class="eff-buffMult w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-xs text-white" value="${bMult}" step="0.5" oninput="updateLivePreview()">
                    </div>
                `;
            }

            const html = `
                <div id="${blockId}" class="effect-block relative bg-slate-800 p-3 rounded-lg border-l-4 ${colorBorder} shadow-sm" data-type="${type}">
                    <button onclick="removeEffectBlock('${blockId}')" class="absolute top-2 right-2 text-slate-500 hover:text-red-400 font-bold px-1">‚úï</button>
                    <div class="font-semibold text-sm text-slate-200 mb-1">${typeLabel} <span class="text-[10px] text-slate-500 font-normal">(${type})</span></div>
                    ${targetSelectHtml}
                    ${fieldsHtml}
                </div>
            `;
            
            document.getElementById('dynamic_effects_container').insertAdjacentHTML('beforeend', html);
            if (!effData) updateLivePreview();
        }

        function generateDraftSkill() {
            // ‡πÉ‡∏ä‡πâ ID ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏¢‡∏π‡πà
            const id = editingSkillId ? editingSkillId : "SK_" + String(skillCounter).padStart(3, '0');
            const skill = {
                id: id,
                name: document.getElementById('c_name').value.trim() || `‡∏™‡∏Å‡∏¥‡∏•‡πÉ‡∏´‡∏°‡πà #${skillCounter}`,
                castTime: parseFloat(document.getElementById('c_castTime').value) || 0,
                cooldown: parseFloat(document.getElementById('c_cooldown').value) || 1.0,
                uninterruptible: document.getElementById('c_uninterruptible').checked,
                desc: document.getElementById('c_desc').value.trim() || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢",
                effects: []
            };

            const blocks = document.querySelectorAll('.effect-block');
            blocks.forEach(block => {
                const type = block.getAttribute('data-type');
                const target = block.querySelector('.eff-target').value;
                
                let eff = { type: type, target: target };

                if (type === "CONDITION") {
                    eff.stat = block.querySelector('.eff-condStat').value;
                    eff.operator = block.querySelector('.eff-condOp').value;
                    eff.value = parseFloat(block.querySelector('.eff-condVal').value) || 0;
                } else if (type === "DAMAGE") {
                    eff.dmgType = block.querySelector('.eff-dmgType').value;
                    eff.mult = parseFloat(block.querySelector('.eff-dmgMult').value) || 1.0;
                    eff.baseMin = parseInt(block.querySelector('.eff-dmgMin').value) || 0;
                    eff.baseMax = parseInt(block.querySelector('.eff-dmgMax').value) || 0;
                } else if (type === "HEAL") {
                    eff.base = parseInt(block.querySelector('.eff-healBase').value) || 0;
                } else if (type === "STUN") {
                    eff.chance = parseFloat(block.querySelector('.eff-stunChance').value) || 1.0;
                    eff.duration = parseFloat(block.querySelector('.eff-stunDur').value) || 1.0;
                } else if (type === "BUFF_NEXT_SKILL") {
                    eff.buffType = "DAMAGE_MULT";
                    eff.mult = parseFloat(block.querySelector('.eff-buffMult').value) || 2.0;
                }

                skill.effects.push(eff);
            });

            return skill;
        }

        function updateLivePreview() {
            const draft = generateDraftSkill();
            document.getElementById('live_json_preview').textContent = JSON.stringify(draft, null, 2);
            document.getElementById('creator_error').classList.add('hidden');
        }

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
        function resetForm() {
            editingSkillId = null;
            document.getElementById('c_name').value = "";
            document.getElementById('c_desc').value = "";
            document.getElementById('c_castTime').value = 0;
            document.getElementById('c_cooldown').value = 3.0;
            document.getElementById('c_uninterruptible').checked = false;
            document.getElementById('dynamic_effects_container').innerHTML = "";
            
            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ UI
            document.getElementById('editing_badge').classList.add('hidden');
            const saveBtn = document.getElementById('save_btn');
            saveBtn.innerHTML = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Å‡∏¥‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
            saveBtn.classList.remove('w-2/3', 'from-yellow-600', 'to-orange-600', 'hover:from-yellow-500', 'hover:to-orange-500');
            saveBtn.classList.add('w-full', 'from-purple-600', 'to-indigo-600', 'hover:from-purple-500', 'hover:to-indigo-500');
            document.getElementById('cancel_edit_btn').classList.add('hidden');
            
            updateLivePreview();
        }

        function saveSkill() {
            const skill = generateDraftSkill();
            
            if (skill.effects.length === 0) {
                document.getElementById('creator_error').classList.remove('hidden');
                return;
            }

            skillDB[skill.id] = skill;
            
            if (!editingSkillId) {
                skillCounter++; // ‡πÄ‡∏û‡∏¥‡πà‡∏° Counter ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            }

            resetForm();
            renderSkillLibrary();
            renderSkillSelects();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏Å‡∏¥‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÅ‡∏Å‡πâ
        function editSkill(skillId) {
            const skill = skillDB[skillId];
            if (!skill) return;

            editingSkillId = skillId;
            document.getElementById('c_name').value = skill.name;
            document.getElementById('c_desc').value = skill.desc;
            document.getElementById('c_castTime').value = skill.castTime;
            document.getElementById('c_cooldown').value = skill.cooldown;
            document.getElementById('c_uninterruptible').checked = skill.uninterruptible;

            document.getElementById('dynamic_effects_container').innerHTML = "";
            
            // ‡πÇ‡∏´‡∏•‡∏î Effect Blocks ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            skill.effects.forEach(eff => {
                addEffectBlock(eff.type, eff);
            });

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô UI ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            document.getElementById('editing_badge').classList.remove('hidden');
            const saveBtn = document.getElementById('save_btn');
            saveBtn.innerHTML = "üíæ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏Å‡∏¥‡∏• (Update)";
            saveBtn.classList.remove('w-full', 'from-purple-600', 'to-indigo-600', 'hover:from-purple-500', 'hover:to-indigo-500');
            saveBtn.classList.add('w-2/3', 'from-yellow-600', 'to-orange-600', 'hover:from-yellow-500', 'hover:to-orange-500');
            document.getElementById('cancel_edit_btn').classList.remove('hidden');

            updateLivePreview();
            
            // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('skill_form').scrollIntoView({ behavior: 'smooth' });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏Å‡∏¥‡∏•
        function deleteSkill(skillId) {
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏Å‡∏¥‡∏• [${skillDB[skillId].name}] ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n*‡∏´‡∏≤‡∏Å‡∏™‡∏Å‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ñ‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`)) return;
            
            delete skillDB[skillId];
            
            // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏™‡∏Å‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á Edit ‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
            if (editingSkillId === skillId) {
                resetForm();
            }

            renderSkillLibrary();
            renderSkillSelects();
        }

        // -----------------------------------------------------------
        // 2. UI RENDERERS
        // -----------------------------------------------------------
        function renderSkillLibrary() {
            const container = document.getElementById('skill_library_container');
            let html = '';
            
            const skills = Object.values(skillDB);
            if (skills.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center text-slate-500 py-6 border border-dashed border-slate-700 rounded-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏Å‡∏¥‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏Å‡∏¥‡∏•‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>`;
                return;
            }

            skills.forEach(sk => {
                let badgeHtml = '';
                if (sk.effects.some(e => e.type === "CONDITION")) badgeHtml += `<span class="inline-block bg-yellow-900/80 border border-yellow-500 text-yellow-200 text-[10px] px-1.5 py-0.5 rounded mb-1 mr-1">‚ùì ‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</span>`;
                if (sk.effects.some(e => e.dmgType === "PHYSICAL")) badgeHtml += `<span class="inline-block bg-orange-900/50 border border-orange-700 text-orange-300 text-[10px] px-2 py-0.5 rounded-full mb-1 mr-1">‚öîÔ∏è ‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û</span>`;
                if (sk.effects.some(e => e.dmgType === "MAGICAL")) badgeHtml += `<span class="inline-block bg-blue-900/50 border border-blue-700 text-blue-300 text-[10px] px-2 py-0.5 rounded-full mb-1 mr-1">‚ú® ‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå</span>`;
                if (sk.uninterruptible) badgeHtml += `<span class="inline-block bg-indigo-900/50 border border-indigo-700 text-indigo-300 text-[10px] px-2 py-0.5 rounded-full mb-1 mr-1">üõ°Ô∏è Super Armor</span>`;
                if (sk.effects.some(e => e.type === "INTERRUPT")) badgeHtml += `<span class="inline-block bg-red-900/50 border border-red-700 text-red-300 text-[10px] px-2 py-0.5 rounded-full mb-1 mr-1">üõë ‡∏Ç‡∏±‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞</span>`;
                if (sk.effects.some(e => e.type === "HEAL")) badgeHtml += `<span class="inline-block bg-emerald-900/50 border border-emerald-700 text-emerald-300 text-[10px] px-2 py-0.5 rounded-full mb-1 mr-1">üíö ‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π</span>`;
                if (sk.effects.some(e => e.type === "STUN")) badgeHtml += `<span class="inline-block bg-purple-900/50 border border-purple-700 text-purple-300 text-[10px] px-2 py-0.5 rounded-full mb-1 mr-1">üí´ ‡∏°‡∏∂‡∏ô‡∏á‡∏á</span>`;
                if (sk.effects.some(e => e.type === "BUFF_NEXT_SKILL")) badgeHtml += `<span class="inline-block bg-pink-900/50 border border-pink-700 text-pink-300 text-[10px] px-2 py-0.5 rounded-full mb-1 mr-1">üî• ‡∏ö‡∏±‡∏ü‡∏™‡∏Å‡∏¥‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>`;

                html += `
                <div class="bg-slate-900 border border-slate-700 rounded-lg p-4 flex flex-col hover:border-slate-500 transition-all shadow-md group">
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-semibold text-white text-base">${sk.name} <span class="text-xs text-slate-500 font-normal">(${sk.id})</span></div>
                        <div class="flex gap-1 opacity-20 group-hover:opacity-100 transition-opacity">
                            <button onclick="editSkill('${sk.id}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏Å‡∏¥‡∏•" class="text-blue-400 hover:text-blue-300 bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded text-xs">‚úèÔ∏è</button>
                            <button onclick="deleteSkill('${sk.id}')" title="‡∏•‡∏ö‡∏™‡∏Å‡∏¥‡∏•" class="text-red-400 hover:text-red-300 bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded text-xs">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="flex flex-wrap mb-2">
                        ${badgeHtml}
                    </div>
                    <div class="text-[11px] text-slate-400 mb-3 bg-slate-800 p-1.5 rounded text-center grid grid-cols-2 gap-2">
                        <div>‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡πà‡∏≤‡∏¢: <span class="text-white">${sk.castTime}s</span></div>
                        <div>‚è≥ ‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå: <span class="text-white">${sk.cooldown}s</span></div>
                    </div>
                    <div class="text-sm text-slate-300 leading-relaxed mt-auto border-t border-slate-800 pt-3">
                        ${sk.desc}
                    </div>
                </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderSkillSelects() {
            const p1Wrapper = document.getElementById('p1_select_wrapper');
            const p2Wrapper = document.getElementById('p2_select_wrapper');
            
            const skills = Object.values(skillDB);
            if (skills.length === 0) {
                p1Wrapper.innerHTML = `<div class="text-xs text-slate-500 text-center italic py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏Å‡∏¥‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`;
                p2Wrapper.innerHTML = `<div class="text-xs text-slate-500 text-center italic py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏Å‡∏¥‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`;
                return;
            }

            // ‡∏à‡∏î‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            let oldP1 = [];
            let oldP2 = [];
            for(let i=0; i<5; i++) {
                const s1 = document.getElementById(`p1_sk_${i}`);
                const s2 = document.getElementById(`p2_sk_${i}`);
                if (s1) oldP1.push(s1.value);
                if (s2) oldP2.push(s2.value);
            }

            let optionsHtml = `<option value="">-- ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ --</option>`;
            optionsHtml += skills.map(sk => `<option value="${sk.id}">[${sk.cooldown}s] ${sk.name}</option>`).join('');

            let p1Html = '';
            let p2Html = '';
            for(let i=0; i<5; i++) {
                p1Html += `<div class="flex items-center gap-2"><span class="text-slate-500 text-xs w-4">${i+1}.</span><select id="p1_sk_${i}" class="flex-1 bg-slate-800 border border-slate-600 rounded p-1.5 text-xs text-white">${optionsHtml}</select></div>`;
                p2Html += `<div class="flex items-center gap-2"><span class="text-slate-500 text-xs w-4">${i+1}.</span><select id="p2_sk_${i}" class="flex-1 bg-slate-800 border border-slate-600 rounded p-1.5 text-xs text-white">${optionsHtml}</select></div>`;
            }
            
            p1Wrapper.innerHTML = p1Html;
            p2Wrapper.innerHTML = p2Html;

            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡πä‡∏Å‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏Å‡∏¥‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
            setTimeout(() => {
                for(let i=0; i<5; i++) {
                    const s1 = document.getElementById(`p1_sk_${i}`);
                    const s2 = document.getElementById(`p2_sk_${i}`);
                    
                    if (oldP1[i] && skillDB[oldP1[i]]) s1.value = oldP1[i];
                    else if (oldP1[i]) s1.value = ""; // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏∑‡∏≠‡∏™‡∏Å‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
                    
                    if (oldP2[i] && skillDB[oldP2[i]]) s2.value = oldP2[i];
                    else if (oldP2[i]) s2.value = ""; 
                }
            }, 10);
        }

        updateLivePreview();
        renderSkillSelects();

        // -----------------------------------------------------------
        // 3. CORE ENGINE: THE EVENT-DRIVEN TIMELINE (‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏ö Target)
        // -----------------------------------------------------------
        function runSimulation() {
            document.getElementById('sim_error').classList.add('hidden');
            
            if (Object.keys(skillDB).length === 0) {
                document.getElementById('sim_error').classList.remove('hidden');
                return;
            }

            let p1CritStat = parseInt(document.getElementById('p1_critChance').value);
            let p1 = {
                id: "USER_01", name: "‡∏≠‡∏±‡∏®‡∏ß‡∏¥‡∏ô‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î (‡πÄ‡∏£‡∏≤)", 
                hp: parseInt(document.getElementById('p1_hp').value), maxHp: parseInt(document.getElementById('p1_hp').value),
                baseAtk: parseInt(document.getElementById('p1_baseAtk').value), physAtk: parseInt(document.getElementById('p1_physAtk').value),
                magAtk: parseInt(document.getElementById('p1_magAtk').value), critAtk: parseInt(document.getElementById('p1_critAtk').value),
                baseDef: parseInt(document.getElementById('p1_baseDef').value), physDef: parseInt(document.getElementById('p1_physDef').value),
                magDef: parseInt(document.getElementById('p1_magDef').value),
                accuracy: parseInt(document.getElementById('p1_accuracy').value), evasion: parseInt(document.getElementById('p1_evasion').value),
                critChance: p1CritStat / (100 + p1CritStat),
                skills: [], cooldowns: {}, casting: null, stunUntil: 0, nextSkillDmgMult: 1.0 
            };
            
            let p2CritStat = parseInt(document.getElementById('p2_critChance').value);
            let p2 = {
                id: "MONSTER_01", name: "‡∏£‡∏≤‡∏ä‡∏±‡∏ô‡∏¢‡πå‡∏≠‡∏≠‡∏£‡πå‡∏Ñ (‡∏®‡∏±‡∏ï‡∏£‡∏π)", 
                hp: parseInt(document.getElementById('p2_hp').value), maxHp: parseInt(document.getElementById('p2_hp').value),
                baseAtk: parseInt(document.getElementById('p2_baseAtk').value), physAtk: parseInt(document.getElementById('p2_physAtk').value),
                magAtk: parseInt(document.getElementById('p2_magAtk').value), critAtk: parseInt(document.getElementById('p2_critAtk').value),
                baseDef: parseInt(document.getElementById('p2_baseDef').value), physDef: parseInt(document.getElementById('p2_physDef').value),
                magDef: parseInt(document.getElementById('p2_magDef').value),
                accuracy: parseInt(document.getElementById('p2_accuracy').value), evasion: parseInt(document.getElementById('p2_evasion').value),
                critChance: p2CritStat / (100 + p2CritStat),
                skills: [], cooldowns: {}, casting: null, stunUntil: 0, nextSkillDmgMult: 1.0
            };

            let hasSkill = false;
            for(let i=0; i<5; i++) {
                let p1SkId = document.getElementById(`p1_sk_${i}`)?.value;
                let p2SkId = document.getElementById(`p2_sk_${i}`)?.value;
                
                if (p1SkId && skillDB[p1SkId]) {
                    p1.skills.push(skillDB[p1SkId]);
                    p1.cooldowns[p1SkId] = skillDB[p1SkId].cooldown;
                    hasSkill = true;
                }
                if (p2SkId && skillDB[p2SkId]) {
                    p2.skills.push(skillDB[p2SkId]);
                    p2.cooldowns[p2SkId] = skillDB[p2SkId].cooldown;
                    hasSkill = true;
                }
            }

            if (!hasSkill) {
                document.getElementById('sim_error').classList.remove('hidden');
                return;
            }

            let t = 0; 
            let timelineEvents = []; 
            let fsLogData = { battleId: "BTL_" + Math.floor(Math.random()*10000), result: "", timeline: [] };
            let uiLogHtml = "";
            let currentLogTime = -1; 
            
            const addUiLog = (time, html) => { 
                let timeStr = time.toFixed(1);
                if (currentLogTime !== timeStr) {
                    uiLogHtml += `
                    <div class="mt-4 mb-2 flex items-center">
                        <div class="bg-indigo-900/60 border border-indigo-700 text-indigo-300 text-[11px] font-semibold px-2 py-1 rounded shadow-sm">
                            ‚è±Ô∏è ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà ${timeStr}
                        </div>
                        <div class="h-px bg-slate-700 flex-1 ml-2"></div>
                    </div>`;
                    currentLogTime = timeStr;
                }
                uiLogHtml += `<div class="mb-1 pl-4 border-l-2 border-slate-600 ml-4 py-0.5 leading-relaxed"> ${html}</div>`; 
            };

            addUiLog(0, `<span class="text-yellow-400 font-bold">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ! (‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏Å‡∏¥‡∏•...)</span>`);

            timelineEvents.push({ t: 0, type: "THINK", entity: p1 });
            timelineEvents.push({ t: 0, type: "THINK", entity: p2 });

            let loopSafety = 0; 

            while (timelineEvents.length > 0 && p1.hp > 0 && p2.hp > 0 && t < 60 && loopSafety < 500) {
                loopSafety++;
                
                timelineEvents.sort((a, b) => a.t - b.t);
                let event = timelineEvents.shift();
                t = event.t;

                let ent = event.entity;
                let defaultEnemy = (ent === p1) ? p2 : p1;

                if (event.type === "THINK") {
                    if (ent.stunUntil > t) continue;
                    if (ent.casting) continue; 

                    let skillToUse = null;
                    let nextAvailableTime = 999; 

                    for (let skill of ent.skills) {
                        let cdEnd = ent.cooldowns[skill.id] || 0;
                        if (cdEnd <= t) {
                            skillToUse = skill; 
                            break; 
                        } else {
                            if (cdEnd < nextAvailableTime) nextAvailableTime = cdEnd;
                        }
                    }

                    if (skillToUse) {
                        if (skillToUse.castTime > 0) {
                            ent.casting = skillToUse;
                            addUiLog(t, `<span class="text-blue-300">‚è≥ ${ent.name} ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡πà‡∏≤‡∏¢ <b class="skill-hoverable cursor-help underline decoration-dotted decoration-blue-400 underline-offset-4 text-blue-300 transition-colors hover:text-blue-200" data-skill-id="${skillToUse.id}">[${skillToUse.name}]</b>...</span>`);
                            fsLogData.timeline.push({ t: Number(t.toFixed(1)), c: ent.id, act: "CAST", sk: skillToUse.id });
                            
                            timelineEvents.push({ t: t + skillToUse.castTime, type: "EXECUTE", entity: ent, skill: skillToUse });
                        } else {
                            timelineEvents.push({ t: t, type: "EXECUTE", entity: ent, skill: skillToUse });
                        }
                    } else {
                        if (nextAvailableTime < 999) {
                            timelineEvents.push({ t: nextAvailableTime, type: "THINK", entity: ent });
                        }
                    }
                }

                else if (event.type === "EXECUTE") {
                    let skill = event.skill;

                    if (skill.castTime > 0 && ent.casting !== skill) {
                        continue; 
                    }

                    ent.casting = null; 
                    ent.cooldowns[skill.id] = t + skill.cooldown; 
                    
                    addUiLog(t, `<span class="text-white">‚öîÔ∏è ${ent.name} ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô <b class="skill-hoverable cursor-help underline decoration-dotted decoration-indigo-400 underline-offset-4 text-indigo-300 transition-colors hover:text-indigo-200" data-skill-id="${skill.id}">[${skill.name}]</b>!</span>`);
                    fsLogData.timeline.push({ t: Number(t.toFixed(1)), c: ent.id, act: "USE", sk: skill.id });

                    let hadNextSkillBuff = ent.nextSkillDmgMult > 1.0;
                    let currentSkillMult = ent.nextSkillDmgMult;

                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏ö‡∏´‡∏•‡∏µ‡∏Å (‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Effect ‡πÄ‡∏ä‡∏¥‡∏á‡∏£‡∏∏‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô ENEMY)
                    let isOffensiveEnemy = skill.effects.some(e => ["DAMAGE", "INTERRUPT", "STUN"].includes(e.type) && e.target === "ENEMY");
                    let isHit = true;

                    if (isOffensiveEnemy) {
                        let hitChance = ent.accuracy / (100 + defaultEnemy.evasion);
                        isHit = Math.random() < hitChance;
                        
                        if (!isHit) {
                            addUiLog(t, `<span class="text-slate-400 pl-4 font-semibold italic">üí® ‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏õ‡πâ‡∏≤! ${defaultEnemy.name} ‡∏´‡∏•‡∏ö‡∏´‡∏•‡∏µ‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡πÑ‡∏î‡πâ</span>`);
                            fsLogData.timeline.push({ t: Number(t.toFixed(1)), c: ent.id, act: "MISS", tgt: defaultEnemy.id });
                        }
                    }

                    // --- ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ï‡∏≤‡∏° Rule-based Effects ---
                    for (let eff of skill.effects) {
                        
                        let actualTarget = (eff.target === "SELF") ? ent : defaultEnemy;

                        // ===== ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (Condition Gate) =====
                        if (eff.type === "CONDITION") {
                            let statValue = 0;
                            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Status ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                            switch (eff.stat) {
                                case "HP_PERCENT": statValue = (actualTarget.hp / actualTarget.maxHp) * 100; break;
                                case "HP_CURRENT": statValue = actualTarget.hp; break;
                                case "BASE_ATK": statValue = actualTarget.baseAtk; break;
                                case "PHYS_DEF": statValue = actualTarget.physDef; break;
                                case "MAG_DEF": statValue = actualTarget.magDef; break;
                                case "ACCURACY": statValue = actualTarget.accuracy; break;
                                case "EVASION": statValue = actualTarget.evasion; break;
                            }

                            let conditionMet = false;
                            // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤
                            switch (eff.operator) {
                                case "<": conditionMet = statValue < eff.value; break;
                                case "<=": conditionMet = statValue <= eff.value; break;
                                case "==": conditionMet = statValue === eff.value; break;
                                case ">=": conditionMet = statValue >= eff.value; break;
                                case ">": conditionMet = statValue > eff.value; break;
                            }

                            // ‡∏´‡∏≤‡∏Å‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏ó‡πá‡∏à" ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≠‡πÜ ‡πÑ‡∏õ‡πÉ‡∏ô‡∏™‡∏Å‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (break ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏õ for)
                            if (!conditionMet) {
                                addUiLog(t, `<span class="text-slate-500 pl-4 text-xs italic">...‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>`);
                                fsLogData.timeline.push({ t: Number(t.toFixed(1)), c: ent.id, act: "COND_FAIL", sk: skill.id });
                                break; 
                            }
                            // ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô ‡∏Å‡πá‡∏à‡∏∞‡∏£‡∏±‡∏ô‡∏•‡∏π‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
                        }

                        if (eff.type === "BUFF_NEXT_SKILL") {
                            actualTarget.nextSkillDmgMult = eff.mult; // ‡∏ö‡∏±‡∏ü‡πÉ‡∏´‡πâ Target ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
                            addUiLog(t, `<span class="text-pink-400 pl-4 font-bold">üî• ${actualTarget.name} ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏û‡∏•‡∏±‡∏á! ‡∏™‡∏Å‡∏¥‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏à‡∏∞‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏Ç‡∏∂‡πâ‡∏ô ${eff.mult} ‡πÄ‡∏ó‡πà‡∏≤</span>`);
                            fsLogData.timeline.push({ t: Number(t.toFixed(1)), c: ent.id, act: "BUFF_NEXT", tgt: actualTarget.id, mult: eff.mult });
                            hadNextSkillBuff = false; 
                        }

                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡πà‡∏≤‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏®‡∏±‡∏ï‡∏£‡∏π‡πÅ‡∏ï‡πà‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏õ‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏õ
                        if (["DAMAGE", "INTERRUPT", "STUN"].includes(eff.type) && eff.target === "ENEMY" && !isHit) {
                            continue;
                        }

                        if (eff.type === "DAMAGE") {
                            let baseDmg = eff.base !== undefined ? eff.base : (Math.floor(Math.random() * (eff.baseMax - eff.baseMin + 1)) + eff.baseMin);
                            let incomingDamage = 0;
                            let targetDefTotal = 0;
                            let dmgTypeStr = "";

                            if (eff.dmgType === "PHYSICAL") {
                                incomingDamage = (ent.baseAtk + ent.physAtk) * eff.mult + baseDmg;
                                targetDefTotal = actualTarget.baseDef + actualTarget.physDef;
                                dmgTypeStr = "‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û";
                            } else if (eff.dmgType === "MAGICAL") {
                                incomingDamage = (ent.baseAtk + ent.magAtk) * eff.mult + baseDmg;
                                targetDefTotal = actualTarget.baseDef + actualTarget.magDef;
                                dmgTypeStr = "‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå";
                            }

                            incomingDamage = incomingDamage * currentSkillMult;

                            let isCrit = Math.random() < ent.critChance;
                            if (isCrit) {
                                incomingDamage = (incomingDamage * 2) + ent.critAtk;
                            }

                            let defMultiplier = 100 / (100 + targetDefTotal);
                            let finalDmg = Math.max(1, Math.floor(incomingDamage * defMultiplier));
                            
                            actualTarget.hp -= finalDmg;
                            
                            let critBadge = isCrit ? `<span class="text-red-400 font-bold ml-1 border border-red-500 bg-red-900/40 text-[10px] px-1 py-0.5 rounded">üí• ‡∏Ñ‡∏£‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏≠‡∏•!</span>` : "";
                            let buffBadge = currentSkillMult > 1.0 ? `<span class="text-pink-300 font-bold ml-1 text-[11px]">(‡∏ö‡∏±‡∏ü x${currentSkillMult})</span>` : "";
                            let colorClass = eff.dmgType === "PHYSICAL" ? "text-orange-400" : "text-blue-400";
                            
                            addUiLog(t, `<span class="${colorClass} pl-4">üó°Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢${dmgTypeStr} ${finalDmg} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ ${actualTarget.name}${buffBadge}${critBadge} <span class="text-slate-500">(HP: ${Math.max(0, actualTarget.hp)})</span></span>`);
                            fsLogData.timeline.push({ t: Number(t.toFixed(1)), c: ent.id, act: "DMG", tgt: actualTarget.id, val: finalDmg, isCrit: isCrit, buffMult: currentSkillMult });
                        }

                        if (eff.type === "HEAL") {
                            actualTarget.hp = Math.min(actualTarget.maxHp, actualTarget.hp + eff.base);
                            addUiLog(t, `<span class="text-emerald-400 pl-4">üíö ‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÉ‡∏´‡πâ ${actualTarget.name} ${eff.base} ‡∏´‡∏ô‡πà‡∏ß‡∏¢ <span class="text-slate-500">(HP: ${actualTarget.hp})</span></span>`);
                            fsLogData.timeline.push({ t: Number(t.toFixed(1)), c: ent.id, act: "HEAL", tgt: actualTarget.id, val: eff.base });
                        }

                        if (eff.type === "INTERRUPT") {
                            if (actualTarget.casting) { 
                                let targetSkill = actualTarget.casting;
                                if (targetSkill.uninterruptible) {
                                    addUiLog(t, `<span class="text-indigo-400 pl-4">üõ°Ô∏è ${actualTarget.name} ‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞!</span>`);
                                    fsLogData.timeline.push({ t: Number(t.toFixed(1)), c: ent.id, act: "INT_FAIL", tgt: actualTarget.id });
                                } else {
                                    actualTarget.casting = null; 
                                    actualTarget.cooldowns[targetSkill.id] = t + targetSkill.cooldown;
                                    addUiLog(t, `<span class="text-red-400 pl-4 font-bold">üõë ‡∏Ç‡∏±‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á ${actualTarget.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>`);
                                    fsLogData.timeline.push({ t: Number(t.toFixed(1)), c: ent.id, act: "INT_SUCCESS", tgt: actualTarget.id });
                                    timelineEvents.push({ t: t, type: "THINK", entity: actualTarget });
                                }
                            }
                        }

                        if (eff.type === "STUN") {
                            if (Math.random() < eff.chance) { 
                                if (actualTarget.casting && actualTarget.casting.uninterruptible) {
                                    addUiLog(t, `<span class="text-indigo-400 pl-4">üõ°Ô∏è ${actualTarget.name} ‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏°‡∏∂‡∏ô‡∏á‡∏á!</span>`);
                                    fsLogData.timeline.push({ t: Number(t.toFixed(1)), c: ent.id, act: "STUN_FAIL", tgt: actualTarget.id });
                                } else {
                                    let interruptMsg = "";
                                    if (actualTarget.casting) {
                                        actualTarget.cooldowns[actualTarget.casting.id] = t + actualTarget.casting.cooldown;
                                        actualTarget.casting = null;
                                        interruptMsg = " <span class='text-xs text-red-400'>(‡∏Ç‡∏±‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏¢)</span>";
                                    }
                                    
                                    actualTarget.stunUntil = Math.max(actualTarget.stunUntil, t + eff.duration);
                                    addUiLog(t, `<span class="text-purple-400 pl-4 font-bold">üí´ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ ${actualTarget.name} ‡∏°‡∏∂‡∏ô‡∏á‡∏á ${eff.duration} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ!${interruptMsg}</span>`);
                                    fsLogData.timeline.push({ t: Number(t.toFixed(1)), c: ent.id, act: "STUN", tgt: actualTarget.id, dur: eff.duration });
                                    
                                    timelineEvents.push({ t: actualTarget.stunUntil, type: "THINK", entity: actualTarget });
                                }
                            }
                        }
                    }

                    if (hadNextSkillBuff) {
                        ent.nextSkillDmgMult = 1.0; 
                    }

                    timelineEvents.push({ t: t, type: "THINK", entity: ent });
                }
                
                if (timelineEvents.length === 0 || timelineEvents[0].t > t) {
                    if (p1.hp <= 0 && p2.hp <= 0) break; 
                    else if (p1.hp <= 0 || p2.hp <= 0) break; 
                }
            } 

            if (p1.hp <= 0 && p2.hp <= 0) {
                addUiLog(t, `<span class="text-slate-400 font-bold text-lg mt-2 block">ü§ù ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (‡πÄ‡∏™‡∏°‡∏≠)!</span>`);
                fsLogData.result = "DOUBLE_KO";
            } else if (p2.hp <= 0) {
                addUiLog(t, `<span class="text-yellow-400 font-bold text-lg mt-2 block">üéâ ${p1.name} ‡∏ä‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ!</span>`);
                fsLogData.result = p1.id + "_WIN";
            } else if (p1.hp <= 0) {
                addUiLog(t, `<span class="text-red-500 font-bold text-lg mt-2 block">üíÄ ${p1.name} ‡∏û‡πà‡∏≤‡∏¢‡πÅ‡∏û‡πâ!</span>`);
                fsLogData.result = p2.id + "_WIN";
            } else {
                addUiLog(t, `<span class="text-slate-400 font-bold text-lg mt-2 block">‚è≥ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ (‡πÄ‡∏™‡∏°‡∏≠)</span>`);
                fsLogData.result = "TIME_OUT";
            }

            document.getElementById('ui_log').innerHTML = uiLogHtml;
            const uiLogEl = document.getElementById('ui_log');
            uiLogEl.scrollTop = uiLogEl.scrollHeight;

            document.getElementById('fs_log').textContent = JSON.stringify(fsLogData, null, 2);
        }

        // -----------------------------------------------------------
        // 4. TOOLTIP SYSTEM
        // -----------------------------------------------------------
        document.addEventListener('mouseover', (e) => {
            const target = e.target.closest('.skill-hoverable');
            if (target) {
                const skillId = target.getAttribute('data-skill-id');
                const skill = skillDB[skillId];
                if (skill) {
                    const tooltip = document.getElementById('global_tooltip');
                    
                    document.getElementById('tt_name').textContent = skill.name;
                    document.getElementById('tt_cast').textContent = skill.castTime;
                    document.getElementById('tt_cd').textContent = skill.cooldown;
                    document.getElementById('tt_desc').textContent = skill.desc;

                    let badgeHtml = '';
                    if (skill.effects.some(eff => eff.type === "CONDITION")) badgeHtml += `<span class="inline-block bg-yellow-900/80 border border-yellow-500 text-yellow-200 text-[10px] px-1.5 py-0.5 rounded mb-1 mr-1">‚ùì ‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</span>`;
                    if (skill.effects.some(eff => eff.dmgType === "PHYSICAL")) badgeHtml += `<span class="inline-block bg-orange-900/80 border border-orange-500 text-orange-200 text-[10px] px-1.5 py-0.5 rounded mb-1 mr-1">‚öîÔ∏è ‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û</span>`;
                    if (skill.effects.some(eff => eff.dmgType === "MAGICAL")) badgeHtml += `<span class="inline-block bg-blue-900/80 border border-blue-500 text-blue-200 text-[10px] px-1.5 py-0.5 rounded mb-1 mr-1">‚ú® ‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå</span>`;
                    if (skill.uninterruptible) badgeHtml += `<span class="inline-block bg-indigo-900/80 border border-indigo-500 text-indigo-200 text-[10px] px-1.5 py-0.5 rounded mb-1 mr-1">üõ°Ô∏è Super Armor</span>`;
                    if (skill.effects.some(eff => eff.type === "INTERRUPT")) badgeHtml += `<span class="inline-block bg-red-900/80 border border-red-500 text-red-200 text-[10px] px-1.5 py-0.5 rounded mb-1 mr-1">üõë ‡∏Ç‡∏±‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞</span>`;
                    if (skill.effects.some(eff => eff.type === "HEAL")) badgeHtml += `<span class="inline-block bg-emerald-900/80 border border-emerald-500 text-emerald-200 text-[10px] px-1.5 py-0.5 rounded mb-1 mr-1">üíö ‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π</span>`;
                    if (skill.effects.some(eff => eff.type === "STUN")) badgeHtml += `<span class="inline-block bg-purple-900/80 border border-purple-500 text-purple-200 text-[10px] px-1.5 py-0.5 rounded mb-1 mr-1">üí´ ‡∏°‡∏∂‡∏ô‡∏á‡∏á</span>`;
                    if (skill.effects.some(eff => eff.type === "BUFF_NEXT_SKILL")) badgeHtml += `<span class="inline-block bg-pink-900/80 border border-pink-500 text-pink-200 text-[10px] px-1.5 py-0.5 rounded mb-1 mr-1">üî• ‡∏ö‡∏±‡∏ü‡∏™‡∏Å‡∏¥‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>`;
                    
                    document.getElementById('tt_badges').innerHTML = badgeHtml;
                    
                    positionTooltip(e, tooltip);
                    tooltip.classList.remove('opacity-0');
                    tooltip.classList.add('opacity-100');
                }
            }
        });

        document.addEventListener('mouseout', (e) => {
            if (e.target.closest('.skill-hoverable')) {
                const tooltip = document.getElementById('global_tooltip');
                tooltip.classList.remove('opacity-100');
                tooltip.classList.add('opacity-0');
            }
        });

        document.addEventListener('mousemove', (e) => {
            const tooltip = document.getElementById('global_tooltip');
            if (tooltip.classList.contains('opacity-100')) {
                positionTooltip(e, tooltip);
            }
        });

        function positionTooltip(e, tooltip) {
            let x = e.clientX + 15;
            let y = e.clientY + 15;
            
            const rect = tooltip.getBoundingClientRect();
            const tooltipWidth = 256; 
            
            if (x + tooltipWidth > window.innerWidth) x = e.clientX - tooltipWidth - 15;
            if (y + rect.height > window.innerHeight) y = e.clientY - rect.height - 15;
            
            tooltip.style.left = `${x}px`;
            tooltip.style.top = `${y}px`;
        }
    </script>
</body>
</html>
